<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen OSIS PRO (Online)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* CSS SAMA SEPERTI SEBELUMNYA */
        :root {
            --bg-color: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #3b82f6;
            --accent: #8b5cf6;
            --text: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body {
            background-color: var(--bg-color);
            color: var(--text);
            min-height: 100vh;
            background-image: radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.2) 0%, transparent 20%),
                              radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.2) 0%, transparent 20%);
            background-size: cover; background-position: center; background-attachment: fixed;
        }
        .glass {
            background: var(--glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        #login-page { display: flex; justify-content: center; align-items: center; height: 100vh; z-index: 100; position: relative; }
        .login-card { width: 100%; max-width: 400px; padding: 2rem; text-align: center; }
        .input-group { margin-bottom: 1.5rem; text-align: left; }
        input, select, textarea {
            width: 100%; padding: 12px; margin-top: 5px; background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border); color: white; border-radius: 8px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); }
        button {
            width: 100%; padding: 12px; background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4); }
        button.secondary { background: #475569; } button.danger { background: var(--danger); }
        #dashboard { display: none; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; height: 100%; padding: 1.5rem; display: flex; flex-direction: column; border-right: 1px solid var(--glass-border); }
        .nav-item { padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; color: #94a3b8; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .grid-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { padding: 1.5rem; }
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--glass-border); }
        .task-done { text-decoration: line-through; color: var(--success); opacity: 0.7; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        @media (max-width: 768px) {
            #dashboard { flex-direction: column; }
            .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 1rem; border-right: none; border-bottom: 1px solid var(--glass-border); }
            .nav-item { font-size: 0.8rem; white-space: nowrap; }
            .main-content { padding: 1rem; }
        }
        .hidden { display: none !important; } .text-sm { font-size: 0.85rem; color: #cbd5e1; } .mt-2 { margin-top: 1rem; }
        
        /* Loading Overlay */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p class="mt-2">Menghubungkan Database...</p>
    </div>

    <div id="login-page" class="hidden">
        <div class="glass login-card">
            <h2 style="margin-bottom: 20px;"><i class="fas fa-satellite-dish"></i> OSIS PRO ONLINE</h2>
            <div class="input-group">
                <label>Nama Anda</label>
                <input type="text" id="loginName" placeholder="Masukkan nama...">
            </div>
            <div class="input-group">
                <label>Pilih Role</label>
                <select id="loginRole" onchange="togglePasswordInput()">
                    <option value="Anggota">Anggota</option>
                    <option value="Bendahara">Bendahara</option>
                    <option value="Ketua">Ketua</option>
                </select>
            </div>
            <div class="input-group hidden" id="passwordGroup">
                <label>Password Khusus</label>
                <input type="password" id="loginPass" placeholder="Password...">
            </div>
            <button onclick="handleLogin()">MASUK <i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <div id="dashboard">
        <div class="glass sidebar">
            <h3 style="margin-bottom: 20px; text-align: center;">OSIS ONLINE</h3>
            <div class="nav-item active" onclick="switchTab('home')"><i class="fas fa-home"></i> Dashboard</div>
            <div class="nav-item" onclick="switchTab('tasks')"><i class="fas fa-tasks"></i> Tugas & Poin</div>
            <div class="nav-item" onclick="switchTab('finance')"><i class="fas fa-wallet"></i> Keuangan</div>
            <div class="nav-item" onclick="switchTab('deadlines')"><i class="fas fa-clock"></i> Deadline</div>
            <div class="nav-item" onclick="switchTab('docs')"><i class="fas fa-folder-open"></i> Arsip</div>
            <div class="nav-item" onclick="switchTab('divisi')"><i class="fas fa-users"></i> Divisi</div>
            <div style="flex-grow: 1;"></div>
            <div class="nav-item" style="color: var(--danger);" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</div>
        </div>

        <div class="main-content">
            <div class="header glass" style="padding: 15px; border-radius: 12px;">
                <div>
                    <h2 id="pageTitle">Dashboard</h2>
                    <p class="text-sm">Login: <span id="userNameDisplay" style="color:var(--primary)">User</span></p>
                </div>
                <div class="text-sm"><span style="color:var(--success)">‚óè Online</span></div>
            </div>

            <div id="tab-home" class="tab-content">
                <div class="grid-cards">
                    <div class="glass card">
                        <h3><i class="fas fa-star" style="color: gold;"></i> Klasemen Poin</h3>
                        <div id="leaderboardList" class="mt-2">Loading...</div>
                    </div>
                    <div class="glass card">
                        <h3>Riwayat Log Aktivitas</h3>
                        <ul id="activityLog" class="mt-2" style="list-style: none; max-height: 200px; overflow-y: auto;"></ul>
                    </div>
                </div>
            </div>

            <div id="tab-tasks" class="tab-content hidden">
                <div class="glass card">
                    <h3>Lapor Tugas (+1 Poin)</h3>
                    <input type="text" id="taskDesc" placeholder="Deskripsi tugas...">
                    <button class="mt-2" onclick="submitTask()">Kirim Laporan</button>
                </div>
            </div>

            <div id="tab-finance" class="tab-content hidden">
                <div class="glass card" style="text-align: center; margin-bottom: 1rem;">
                    <p>Total Kas OSIS</p>
                    <h1 id="totalSaldo" style="color: var(--success);">Rp 0</h1>
                </div>
                <div id="financeControls" class="glass card hidden" style="margin-bottom: 1rem;">
                    <h3>Input Transaksi</h3>
                    <select id="finType"><option value="in">Masuk (+)</option><option value="out">Keluar (-)</option></select>
                    <input type="number" id="finAmount" placeholder="Nominal">
                    <input type="text" id="finDesc" placeholder="Keterangan">
                    <button class="mt-2" onclick="addTransaction()">Simpan</button>
                </div>
                <div class="glass card">
                    <table style="width: 100%;">
                        <thead><tr><th>Ket</th><th>Jml</th><th>Aksi</th></tr></thead>
                        <tbody id="financeTable"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-deadlines" class="tab-content hidden">
                <div id="deadlineControls" class="glass card hidden" style="margin-bottom: 1rem;">
                    <h3>Tambah Deadline</h3>
                    <input type="text" id="dlTitle" placeholder="Nama Tugas">
                    <input type="color" id="dlColor" value="#ef4444">
                    <button class="mt-2" onclick="addDeadline()">Tambah</button>
                </div>
                <div class="glass card" id="deadlineList"></div>
            </div>

            <div id="tab-docs" class="tab-content hidden">
                <div id="docControls" class="glass card hidden" style="margin-bottom: 1rem;">
                    <h3>Upload Arsip</h3>
                    <input type="text" id="docName" placeholder="Nama Acara">
                    <input type="text" id="docLink" placeholder="Link GDrive/Youtube">
                    <textarea id="docStory" placeholder="Cerita singkat..." rows="2"></textarea>
                    <button class="mt-2" onclick="addDoc()">Simpan</button>
                </div>
                <div id="docGallery" class="grid-cards"></div>
            </div>

            <div id="tab-divisi" class="tab-content hidden">
                <div id="divControls" class="glass card hidden" style="margin-bottom: 1rem;">
                    <select id="divSelect">
                        <option value="Ketua OSIS">Ketua OSIS</option><option value="Wakil">Wakil</option>
                        <option value="Bendahara">Bendahara</option><option value="Sekretaris">Sekretaris</option>
                        <option value="Logistik">Logistik</option><option value="Humas">Humas</option>
                        <option value="Acara">Acara</option><option value="Pdd">PDD</option><option value="Keamanan">Keamanan</option>
                    </select>
                    <textarea id="divJobdesk" rows="2" placeholder="Jobdesk baru..."></textarea>
                    <button class="mt-2" onclick="updateDivisi()">Update</button>
                </div>
                <div id="divList" class="grid-cards"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // 1. IMPORT FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // 2. KONFIGURASI FIREBASE (PASTE KODE DARI CONSOLE DI SINI)
        const firebaseConfig = {
            apiKey: "AIzaSyA37u87P6zbFiVOdl0KBF7nTB7riFVRbWQ",
            authDomain: "osis-s1c.firebaseapp.com",
            databaseURL: "https://osis-s1c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "osis-s1c",
            storageBucket: "osis-s1c.firebasestorage.app",
            messagingSenderId: "338254985414",
            appId: "1:338254985414:web:0c72ce734226c20d6c3fc7"
        };

        // 3. INITIALIZE
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // --- GLOBAL STATE ---
        let globalData = {
            users: {},
            logs: {},
            finance: {},
            deadlines: {},
            docs: {},
            divisions: {
                "Ketua OSIS": "Memimpin organisasi", "Wakil": "Mendampingi ketua",
                "Bendahara": "Mengelola keuangan", "Sekretaris": "Administrasi",
                "Logistik": "Perlengkapan", "Humas": "Hubungan masyarakat",
                "Acara": "Konsep kegiatan", "Pdd": "Dokumentasi", "Keamanan": "Ketertiban"
            }
        };
        let currentUser = null;

        // --- AUTH & LOAD DATA ---
        window.togglePasswordInput = () => {
            const role = document.getElementById('loginRole').value;
            document.getElementById('passwordGroup').classList.toggle('hidden', role === 'Anggota');
        }

        window.handleLogin = () => {
            const name = document.getElementById('loginName').value;
            const role = document.getElementById('loginRole').value;
            const pass = document.getElementById('loginPass').value;

            if (!name) return alert("Isi nama!");
            if (role === 'Bendahara' && pass !== 'bendahara321') return alert("Password Salah!");
            if (role === 'Ketua' && pass !== 'Ketua 315') return alert("Password Salah!");

            currentUser = { name, role };
            
            // Cek user baru di database
            const userRef = ref(db, 'users/' + name);
            // Kita set default poin 0 jika belum ada, pakai update agar tidak menimpa data lama
            update(ref(db, 'users/' + name), { name: name, role: role });

            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('dashboard').style.display = 'flex';
            document.getElementById('userNameDisplay').innerText = `${name} (${role})`;

            setupRoleAccess();
            renderAll(); // Render awal
        }

        function setupRoleAccess() {
            if (currentUser.role === 'Bendahara') document.getElementById('financeControls').classList.remove('hidden');
            if (currentUser.role === 'Ketua') {
                document.getElementById('deadlineControls').classList.remove('hidden');
                document.getElementById('docControls').classList.remove('hidden');
                document.getElementById('divControls').classList.remove('hidden');
            }
        }

        // --- REALTIME LISTENER (JANTUNG APLIKASI) ---
        // Fungsi ini otomatis jalan setiap ada perubahan data di database manapun
        onValue(ref(db), (snapshot) => {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden'); // Tampilkan login stlh load
            
            const data = snapshot.val();
            if (data) {
                globalData = { ...globalData, ...data }; // Merge data
                if(currentUser) renderAll(); // Re-render jika user sudah login
            }
        });

        // --- RENDERING FUNCTIONS ---
        function renderAll() {
            renderLeaderboard();
            renderLogs();
            renderFinance();
            renderDeadlines();
            renderDocs();
            renderDivisi();
        }

        // 1. LOGIC TUGAS & LOGS
        window.submitTask = () => {
            const desc = document.getElementById('taskDesc').value;
            if(!desc) return;

            // Update Poin User
            const currentPoints = globalData.users[currentUser.name]?.points || 0;
            update(ref(db, 'users/' + currentUser.name), { points: currentPoints + 1 });

            // Push Log Baru
            push(ref(db, 'logs'), {
                name: currentUser.name, desc: desc, date: new Date().toLocaleString()
            });

            document.getElementById('taskDesc').value = '';
            alert("Tugas dicatat!");
        }

        function renderLeaderboard() {
            const usersArray = Object.values(globalData.users || {});
            usersArray.sort((a,b) => (b.points || 0) - (a.points || 0));
            
            document.getElementById('leaderboardList').innerHTML = usersArray.map((u, i) => `
                <div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid rgba(255,255,255,0.1)">
                    <span>#${i+1} ${u.name}</span>
                    <span style="color:gold; font-weight:bold">${u.points || 0} Poin</span>
                </div>
            `).join('');
        }

        function renderLogs() {
            const logsArray = Object.values(globalData.logs || {}).reverse();
            document.getElementById('activityLog').innerHTML = logsArray.map(l => `
                <li style="font-size:0.9rem; margin-bottom:5px; padding:5px; background:rgba(255,255,255,0.05);">
                    <strong>${l.name}</strong>: ${l.desc} <br> <small style="color:#94a3b8">${l.date}</small>
                </li>
            `).join('');
        }

        // 2. LOGIC KEUANGAN
        window.addTransaction = () => {
            const type = document.getElementById('finType').value;
            const amount = parseInt(document.getElementById('finAmount').value);
            const desc = document.getElementById('finDesc').value;
            if(!amount) return;

            push(ref(db, 'finance'), { type, amount, desc, date: new Date().toLocaleDateString() });
            document.getElementById('finAmount').value = '';
            document.getElementById('finDesc').value = '';
        }

        function renderFinance() {
            let total = 0;
            const finArray = Object.entries(globalData.finance || {});
            
            const html = finArray.map(([key, f]) => {
                if(f.type === 'in') total += f.amount; else total -= f.amount;
                
                const delBtn = currentUser.role === 'Bendahara' ? 
                    `<i class="fas fa-trash" style="color:var(--danger); cursor:pointer" onclick="delItem('finance/${key}')"></i>` : '';
                
                return `<tr>
                    <td>${f.desc} <br><small>${f.date}</small></td>
                    <td style="color:${f.type==='in'?'var(--success)':'var(--danger)'}">Rp ${f.amount.toLocaleString()}</td>
                    <td>${delBtn}</td>
                </tr>`;
            }).join('');

            document.getElementById('financeTable').innerHTML = html;
            document.getElementById('totalSaldo').innerText = `Rp ${total.toLocaleString()}`;
        }

        // 3. LOGIC DEADLINE
        window.addDeadline = () => {
            const title = document.getElementById('dlTitle').value;
            const color = document.getElementById('dlColor').value;
            if(!title) return;
            push(ref(db, 'deadlines'), { title, color, done: false });
        }

        function renderDeadlines() {
            const dlArray = Object.entries(globalData.deadlines || {});
            document.getElementById('deadlineList').innerHTML = dlArray.map(([key, dl]) => `
                <div class="task-item">
                    <div class="${dl.done ? 'task-done' : ''}">
                        <span class="badge" style="background:${dl.color}">&nbsp;</span> ${dl.title}
                    </div>
                    <div>
                        <button class="secondary" onclick="toggleDl('${key}', ${dl.done})">${dl.done?'Batal':'Selesai'}</button>
                        ${currentUser.role === 'Ketua' ? `<button class="danger" onclick="delItem('deadlines/${key}')">X</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        window.toggleDl = (key, currentStatus) => update(ref(db, `deadlines/${key}`), { done: !currentStatus });

        // 4. LOGIC DOKUMENTASI
        window.addDoc = () => {
            const title = document.getElementById('docName').value;
            const link = document.getElementById('docLink').value;
            const story = document.getElementById('docStory').value;
            push(ref(db, 'docs'), { title, link, story, date: new Date().toLocaleDateString() });
            alert("Arsip Disimpan");
        }

        function renderDocs() {
            const docArray = Object.values(globalData.docs || {});
            document.getElementById('docGallery').innerHTML = docArray.map(doc => `
                <div class="glass card" onclick="window.open('${doc.link}', '_blank')" style="cursor:pointer;">
                    <h4>${doc.title}</h4> <p class="text-sm mt-2">"${doc.story}"</p>
                </div>
            `).join('');
        }

        // 5. DIVISI
        window.updateDivisi = () => {
            const div = document.getElementById('divSelect').value;
            const job = document.getElementById('divJobdesk').value;
            update(ref(db, `divisions`), { [div]: job });
            alert("Update Sukses");
        }

        function renderDivisi() {
            let html = '';
            for (const [div, job] of Object.entries(globalData.divisions || {})) {
                html += `<div class="glass card"><h4 style="color:var(--accent)">${div}</h4><p class="text-sm">${job}</p></div>`;
            }
            document.getElementById('divList').innerHTML = html;
        }

        // UTILS
        window.delItem = (path) => { if(confirm("Hapus?")) remove(ref(db, path)); }
        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-'+id).classList.remove('hidden');
        }
        window.logout = () => location.reload();

    </script>
</body>
</html>
